---
phase: 02-product-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified: [products/create.php, products/edit.php, products/actions.php]
autonomous: true
requirements: [PROD-02, PROD-03]

must_haves:
  truths:
    - "Admin can access create product form"
    - "Form validates: name required, price ≥ 0, stock ≥ 0"
    - "All validation errors shown together after submit (not inline)"
    - "After successful save, redirect to product list"
    - "Cancel button returns to product list without saving"
    - "Edit form pre-populates with existing product data"
  artifacts:
    - path: "products/create.php"
      provides: "Add product form with validation display"
      min_lines: 60
    - path: "products/edit.php"
      provides: "Edit form with pre-populated values"
      min_lines: 60
    - path: "products/actions.php"
      provides: "CREATE and UPDATE handlers with prepared statements"
      exports: ["POST create", "POST update"]
  key_links:
    - from: "products/create.php"
      to: "products/actions.php"
      via: "form POST with action=create"
      pattern: "action=\"actions\\.php\".*name=\"action\".*value=\"create\""
    - from: "products/edit.php"
      to: "products/actions.php"
      via: "form POST with action=update"
      pattern: "name=\"action\".*value=\"update\""
    - from: "products/actions.php"
      to: "config/database.php"
      via: "require_once for DB connection"
      pattern: "require_once.*database\\.php"
    - from: "products/actions.php"
      to: "products table"
      via: "INSERT/UPDATE prepared statements"
      pattern: "mysqli_prepare.*INSERT INTO products|mysqli_prepare.*UPDATE products"
---

<objective>
Implement create and edit product forms with server-side validation and error display.

Purpose: Allow admin to add new products and modify existing products with proper validation preventing invalid data entry.

Output: Working create.php and edit.php forms, actions.php with CREATE/UPDATE handlers, validation error display showing all errors at once.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-product-management/02-RESEARCH.md
@.planning/phases/02-product-management/02-CONTEXT.md
@products/index.php
@config/database.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create product form (create.php) with validation</name>
  <files>products/create.php</files>
  <action>
    Create products/create.php with add product form:
    
    1. Include: session_config.php, auth_check.php, role_check.php (admin only), header.php, sidebar.php, footer.php
    
    2. Get old input and errors from session (set by actions.php on validation failure):
       - $oldInput = $_SESSION['old_input'] ?? []
       - $errors = $_SESSION['errors'] ?? []
       - Clear session values after reading
    
    3. Display validation errors (if any) in Bootstrap alert-danger with unordered list showing ALL errors at once
    
    4. Form structure (POST to actions.php):
       - Hidden input: action=create
       - Nama Produk (text, required, with old value)
       - Harga Jual (number, min=0, step=0.01, required, with old value)
       - Stok Awal (number, min=0, required, with old value)
       - Kategori (text, optional, with old value)
       - Satuan (select: pcs/box/kg/liter/pack, default=pcs, with old value)
    
    5. Form buttons:
       - "Batal" button (btn-secondary) linking to index.php
       - "Simpan Produk" button (btn-primary) type=submit
    
    6. Use Bootstrap form classes (mb-3, form-label, form-control)
    7. Mark required fields with red asterisk
    8. Add is-invalid class to fields when errors exist (for visual feedback)
  </action>
  <verify>
    Visit products/create.php:
    - Form loads with all fields
    - Submit empty form → shows error "Nama produk wajib diisi"
    - Submit with negative price → shows error "Harga tidak boleh negatif"
    - Submit valid data → redirects to index.php (after actions.php complete)
    - Cancel button returns to product list
  </verify>
  <done>
    Create form displays all fields, shows validation errors in alert box after submit, preserves old input on error, redirects on success, cancel returns to list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create edit form (edit.php) with pre-populated data</name>
  <files>products/edit.php</files>
  <action>
    Create products/edit.php with edit product form:
    
    1. Include: session_config.php, auth_check.php, role_check.php (admin only), header.php, sidebar.php, footer.php
    
    2. Get product ID from query string: $id = intval($_GET['id'])
    
    3. Fetch product from database using prepared statement:
       - SELECT * FROM products WHERE id = ?
       - If product not found, redirect to index.php with error message
    
    4. Get errors from session (similar to create.php)
    
    5. Display validation errors (same pattern as create.php)
    
    6. Form structure (POST to actions.php):
       - Hidden input: action=update
       - Hidden input: id={product_id}
       - Same fields as create.php, but pre-populated with $product data
       - Harga Jual, Stok show current values
       - Form shows "Stok saat ini: X" as helper text
    
    7. Form buttons:
       - "Batal" button (btn-secondary) linking to index.php
       - "Update Produk" button (btn-warning) type=submit
    
    8. Page header uses warning color (bg-warning text-dark) to indicate edit mode
  </action>
  <verify>
    Visit products/edit.php?id=1 (with existing product):
    - Form loads with all fields pre-populated
    - Modify values and submit → updates product
    - Submit with empty name → shows validation error, preserves other values
    - Cancel button returns to product list
    - Visit with invalid ID → redirects with error message
  </verify>
  <done>
    Edit form loads existing product data, allows modification with same validation as create, redirects on success, handles missing product gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement CREATE and UPDATE handlers (actions.php)</name>
  <files>products/actions.php</files>
  <action>
    Create products/actions.php with CREATE and UPDATE handlers:
    
    1. Include: session_start(), require_once '../config/database.php'
    
    2. CREATE handler (POST action=create):
       - Get and sanitize inputs: name (trim), price (floatval), stock (intval), category (trim), unit (trim)
       - Validate:
         * name not empty → errors[] = "Nama produk wajib diisi"
         * price >= 0 → errors[] = "Harga tidak boleh negatif"
         * stock >= 0 → errors[] = "Stok tidak boleh negatif"
       - If errors: store in $_SESSION['errors'], store $_POST in $_SESSION['old_input'], redirect to create.php
       - If no errors: prepared statement INSERT INTO products (name, price, stock, category, unit) VALUES (?, ?, ?, ?, ?)
       - mysqli_stmt_bind_param with types "sdis s" (string, double, int, string, string)
       - On success: $_SESSION['success'] = "Produk berhasil ditambahkan", redirect to index.php
       - On error: $_SESSION['error'] = error message, redirect to create.php
       - Close statement
    
    3. UPDATE handler (POST action=update):
       - Get and sanitize inputs: id (intval), name, price, stock, category, unit
       - Same validation as CREATE
       - If errors: redirect to edit.php?id=$id with errors and old_input
       - If no errors: prepared statement UPDATE products SET name=?, price=?, stock=?, category=?, unit=? WHERE id=?
       - mysqli_stmt_bind_param with types "sdisii" (string, double, int, string, string, int)
       - On success: $_SESSION['success'] = "Produk berhasil diupdate", redirect to index.php
       - Close statement
    
    Use mysqli_prepare() for ALL queries (SQL injection prevention per research).
    Use htmlspecialchars() on ALL output (XSS prevention).
  </action>
  <verify>
    Test CREATE:
    - Submit valid product → success message, product appears in list
    - Submit with empty name → error shown, form preserves other values
    - Submit with negative stock → error shown
    
    Test UPDATE:
    - Edit existing product, change name → name updates in database
    - Edit with invalid price → error shown, other values preserved
    - Verify using: SELECT * FROM products after each operation
  </verify>
  <done>
    CREATE handler adds products with validation, UPDATE handler modifies products with validation, both use prepared statements, both redirect to product list on success, both preserve input on validation failure.
  </done>
</task>

</tasks>

<verification>
- Create form accessible at products/create.php
- Edit form accessible at products/edit.php?id={id}
- Both forms show all validation errors in alert box after submit
- Old input preserved when validation fails
- Successful save redirects to products/index.php with success message
- Cancel buttons return to product list without saving
- actions.php uses prepared statements for INSERT and UPDATE
- Price stored as DECIMAL(10,2), stock as INT UNSIGNED
- Stock validation rejects negative values
</verification>

<success_criteria>
- Admin can add new products with validated data
- Admin can edit existing products
- All validation errors shown together (not inline)
- Invalid data rejected with clear error messages
- Old input preserved on validation failure
- Redirect to product list after successful save
- Cancel buttons work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-management/02-03-SUMMARY.md` with:
- Form field specifications
- Validation rules implemented
- Test results for CREATE and UPDATE operations
</output>
