---
phase: 02-product-management
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified: [products/index.php, products/actions.php]
autonomous: true
requirements: [PROD-04]

must_haves:
  truths:
    - "Delete button in product row triggers confirmation modal"
    - "Modal shows product name being deleted"
    - "Modal emphasizes irreversibility of action"
    - "Confirm delete removes product from database"
    - "After delete, redirect to product list with success message"
    - "Cancel in modal keeps product intact"
  artifacts:
    - path: "products/index.php"
      provides: "Delete button with modal data attributes, modal HTML structure"
      contains: "data-bs-toggle=\"modal\" data-bs-target=\"#deleteModal\""
    - path: "products/actions.php"
      provides: "DELETE handler with prepared statement"
      exports: ["GET delete"]
  key_links:
    - from: "products/index.php"
      to: "Bootstrap modal"
      via: "data-bs-toggle and data-bs-target attributes"
      pattern: "data-bs-toggle=\"modal\".*data-bs-target=\"#deleteModal\""
    - from: "products/index.php"
      to: "products/actions.php"
      via: "Delete confirmation link href"
      pattern: "actions\\.php\\?action=delete&id="
    - from: "products/actions.php"
      to: "products table"
      via: "DELETE prepared statement"
      pattern: "DELETE FROM products WHERE id=\\?"
---

<objective>
Implement delete functionality with Bootstrap modal confirmation dialog.

Purpose: Prevent accidental product deletion by requiring explicit confirmation, while providing clear feedback about the irreversible nature of the action.

Output: Delete confirmation modal in product list, DELETE handler in actions.php, success/error messaging after deletion.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-product-management/02-RESEARCH.md
@.planning/phases/02-product-management/02-CONTEXT.md
@products/index.php
@products/actions.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delete confirmation modal to product list page</name>
  <files>products/index.php</files>
  <action>
    Update products/index.php with Bootstrap 5 delete confirmation modal:
    
    1. Update Delete button in table row Actions column:
       - Add data-bs-toggle="modal"
       - Add data-bs-target="#deleteModal"
       - Add data-id="<?= $row['id'] ?>"
       - Add data-name="<?= htmlspecialchars($row['name']) ?>"
       - Use btn-danger class with trash icon
    
    2. Add modal HTML after table (before closing container div):
       - Modal ID: deleteModal
       - modal-dialog-centered class for centered positioning
       - Modal header: bg-danger text-white, title "Konfirmasi Hapus" with warning icon
       - Modal body:
         * "Apakah Anda yakin ingin menghapus produk:"
         * Product name in large red text (id="productName")
         * Warning: "Tindakan ini tidak dapat dibatalkan."
       - Modal footer:
         * "Batal" button (btn-secondary) with data-bs-dismiss="modal"
         * "Ya, Hapus" link (btn-danger) with id="confirmDelete"
    
    3. Add JavaScript to populate modal with product data:
       - Listen for 'show.bs.modal' event on #deleteModal
       - Get product ID and name from button data attributes
       - Set modal body text with product name
       - Set confirmDelete link href to "actions.php?action=delete&id={id}"
    
    4. Modal styling:
       - Red/danger theme throughout
       - Warning icon (bi-exclamation-triangle)
       - Clear visual hierarchy emphasizing the risk
  </action>
  <verify>
    Click delete button on any product row:
    - Modal appears centered on screen
    - Modal shows correct product name
    - "Batal" button closes modal without action
    - "Ya, Hapus" button URL contains correct product ID
    - Modal has red/danger styling
  </verify>
  <done>
    Delete button triggers modal with product name, modal shows warning about irreversibility, confirm button links to delete handler with product ID, cancel button closes modal safely.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement DELETE handler in actions.php</name>
  <files>products/actions.php</files>
  <action>
    Add DELETE handler to products/actions.php:
    
    1. Handler triggers on: isset($_GET['action']) && $_GET['action'] === 'delete' && isset($_GET['id'])
    
    2. Get and sanitize product ID: $id = intval($_GET['id'])
    
    3. Optional: Check if product exists before deletion:
       - SELECT * FROM products WHERE id = ?
       - If not found, set error message and redirect
    
    4. Optional: Check for transaction dependencies (future-proofing):
       - Comment noting: "Future: check sales table for references"
       - For now, allow deletion (soft delete via is_active preferred for production)
    
    5. Delete using prepared statement:
       - $sql = "DELETE FROM products WHERE id=?"
       - $stmt = mysqli_prepare($conn, $sql)
       - mysqli_stmt_bind_param($stmt, "i", $id)
       - mysqli_stmt_execute($stmt)
    
    6. Set session message:
       - On success: $_SESSION['success'] = "Produk berhasil dihapus"
       - On error: $_SESSION['error'] = "Gagal menghapus produk"
    
    7. Close statement and redirect:
       - mysqli_stmt_close($stmt)
       - header('Location: index.php')
       - exit
    
    Note: Research recommends soft delete (is_active = 0) for production, but hard delete acceptable for Phase 2 scope.
  </action>
  <verify>
    Test delete flow:
    - Click delete on product → modal appears
    - Click "Batal" → modal closes, product still in list
    - Click delete again, click "Ya, Hapus" → product removed from database
    - Redirect to index.php with success message "Produk berhasil dihapus"
    - Verify deletion: SELECT * FROM products WHERE id={deleted_id} returns empty
    
    Test edge cases:
    - Delete non-existent ID → shows error or redirects gracefully
    - Delete without login → redirected by auth_check
    - Cashier role tries to delete → redirected by role_check
  </verify>
  <done>
    Delete handler removes product from database using prepared statement, shows success message after deletion, redirects to product list, handles errors gracefully, restricted to admin role only.
  </done>
</task>

</tasks>

<verification>
- Delete button present in each product row Actions column
- Clicking delete opens Bootstrap modal (not browser confirm())
- Modal displays product name being deleted
- Modal has red/danger styling with warning icon
- "Batal" button closes modal without deleting
- "Ya, Hapus" button deletes product and redirects
- Success message shown after deletion
- Deleted product no longer appears in list
- DELETE query uses prepared statement
- Only admin role can access delete functionality
</verification>

<success_criteria>
- Delete requires explicit confirmation via modal
- Modal clearly communicates irreversibility
- Product successfully removed from database
- User receives feedback (success/error message)
- Delete restricted to admin users
- No JavaScript errors in console
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-management/02-04-SUMMARY.md` with:
- Modal implementation details
- Delete handler confirmation
- Test results for delete flow
- Note on soft delete vs hard delete decision
</output>
